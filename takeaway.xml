<?xml version="1.0" encoding="UTF-8" ?>
<Module>
<ModulePrefs title="Takeaway" height="100">
    <Require feature="wave" />
</ModulePrefs>
<Content type="html">
<![CDATA[
    <div id="content_div" style="height: 50px;"></div>
    <script type="text/javascript">
        var div = document.getElementById('content_div');

        function stateUpdated() {
            if (!wave.getState().get('coins')) {
                delta = {};
                delta['coins'] = '20';
                delta['taker'] = 'nobody';

                wave.getState().submitDelta(delta);
            }

            var coins = wave.getState().get('coins', '0');
            var taker = wave.getState().get('taker');

            div.innerHTML = "There are " + coins + " left.";
            div.innerHTML += "<br />";
            div.innerHTML += "The last person to take away was " + taker " .";

            if (coins == 0) {
                div.innerHTML += "<br />";
                div.innerHTML += taker + " is the loser!";
            }
        }

        function take() {
            var amount = parseInt(document.getElementById('textTake').value);
            var taker = wave.getViewer().getId();
            var state = wave.getState();
            var currentAmt = parseInt(state.get('coins', '0'));
            if (amount < 4 && amount > 0 && amount <= currentAmt) {
                delta = {};
                currentAmt -= amount;
                delta['coins'] = currentAmt;
                delta['taker'] = taker;
                state.submitDelta(delta);
            }
        }

        function reset() {
            wave.getState().submitDelta({'coins': '20', 'taker': 'nobody'});
        }

        function init() {
            if (wave && wave.isInWaveContainer()) {
                wave.setStateCallback(stateUpdated);
                wave.setParticipantCallback(stateUpdated);
            }
        }

        gadgets.util.registerOnLoadHandler(init);

    </script>
    <input type="text" id="textTake" />
    <input type="button" value="Take!" id="butTake" onClick="take()" />
    <input type="button" value="Reset" id="butReset" onClick="reset()" />
]]>
</Content>
</Module>
