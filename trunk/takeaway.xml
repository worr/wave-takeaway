<?xml version="1.0" encoding="UTF-8" ?>
<Module>
<ModulePrefs title="Takeaway" height="120">
    <Require feature="wave" />
</ModulePrefs>
<Content type="html">
<![CDATA[
    <div id="content_div" style="height: 90px;"></div>
    <script type="text/javascript">
        var div = document.getElementById('content_div');

        function stateUpdated() {
            if (!wave.getState().get('coins')) {
                delta = {};
                delta['coins'] = '20';
                delta['taker'] = 'nobody';
                delta['taken'] = '1';

                wave.getState().submitDelta(delta);
            }

            var coins = parseInt(wave.getState().get('coins'));
            var taker = wave.getState().get('taker');
            var taken = parseInt(wave.getState().get('taken'));
            var validity = wave.getState().get('valid');

            div.innerHTML = "There are " + coins + " left.";
            div.innerHTML += "<br />";
            div.innerHTML += "The last person to take away was " + taker + " .";
            div.innerHTML += "<br />";

            if (validity == 'false') {
                div.innerHTML += "Invalid move " + taken + ".";
                div.innerHTML += "<br />";
                div.innerHTML += "Try again " + taker + ".";
            }

            if (coins == 0) {
                div.innerHTML += taker + " is the loser!";
            }
        }

        function take() {
            var amount = parseInt(document.getElementById('textTake').value);
            var taker = wave.getViewer().getId();
            var state = wave.getState();
            var currentAmt = parseInt(state.get('coins', '0'));
            var delta = {};
            delta['taker'] = taker;
            delta['taken'] = amount;
            if (amount < 4 && amount > 0 && amount <= currentAmt) {
                currentAmt -= amount;
                delta['coins'] = currentAmt;
                delta['valid'] = 'true';
            } else {
                delta['valid'] = 'false';
            }

            state.submitDelta(delta);
        }

        function reset() {
            wave.getState().submitDelta({'coins': '20', 'taker': 'nobody', 'taken': '1', 'valid': 'true'});
        }

        function init() {
            if (wave && wave.isInWaveContainer()) {
                wave.setStateCallback(stateUpdated);
                wave.setParticipantCallback(stateUpdated);
            }
        }

        gadgets.util.registerOnLoadHandler(init);

    </script>
    <input type="text" id="textTake" />
    <input type="button" value="Take!" id="butTake" onClick="take()" />
    <input type="button" value="Reset" id="butReset" onClick="reset()" />
]]>
</Content>
</Module>
